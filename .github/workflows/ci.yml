name: Continuous Integration

on:
  push:
    branches: [main]
    tags:
  pull_request:
  release:
  workflow_dispatch:

jobs:
  golangci-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

        # We use the latest version of golangci-lint here.
        # This will produce occasional errors in the future when the linters
        # are updated, but then we always get the newest warnings instead
        # of having to update the CI manually.
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v2
        with:
          go-version: ^1.17

      - uses: actions/checkout@v2

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Vet
        run: go vet ./...

      - name: Setup and Run Tests
        run: |
          cd ..
          curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap.sh | bash -s
          export FABRIC_SAMPLES_DIR=$(pwd)/fabric-samples/
          cd perun-fabric/
          ./scripts/deployCC.sh
          go test -timeout 700s ./... -p 1
          ./scripts/network.sh down
